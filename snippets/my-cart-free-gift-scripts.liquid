{% if product.handle == 'therapiedecken' %}

  {% comment %} Promo variant id - we need the id of one of the variants {% endcomment %}
  {% assign promoVariant = settings.gift_product_variant_id  %}
  {% assign promoSubtotal = settings.gift_product_min_spend  %}

  {% if promoVariant != blank and promoSubtotal != blank %}
    <script type="module">
        import { cartRequestAdd, cartRequestChange, subscribeToCartStateUpdate } from '{{ "liquid-ajax-cart-v1.10.0.js" | asset_url }}';


        subscribeToCartStateUpdate( state => {
        
        	
            console.log("state.cart.item_count ");
           	console.log(state.cart.item_count);
            
            const giftTriggerItem = state.cart.items.filter(item => {                
            	return item.handle === 'therapiedecken';
            });

            
            
            let promoVariant = '34485696430219';
            
            state.cart.items.forEach(item => {
            	if ( item.id == '34485696430219' || item.id == '34440242036875' || item.id == '34440242266251' || item.id == '34440242495627' || item.id == '34440242725003' ) {
                	console.log(" 135 ");
                	promoVariant = '34447711174795';
                } else if ( item.id == 34440242954379 || item.id == '34440243183755' || item.id == '34440243413131' || item.id == '34440243642507' ) {
                	console.log(" 150 item.id: ");
                    console.log(item);
                	promoVariant = '34447711240331';
                };
            });
            
            console.log("promoVariant: ");
            console.log(promoVariant);
            const promoSubtotal = {{ promoSubtotal }}00;

            // If cart state exists and there is no Ajax Cart API request in progress
            if ( state.status.cartStateSet && !state.status.requestInProgress ) {
                let currentSubtotal = state.cart.items_subtotal_price;

                // Find out if there is a product that was automatically added before
                const autoAddedLineItem = state.cart.items.findIndex( lineItem => { 
                    return lineItem.properties?._autoadded === 'Yes' ;
                });

                // If there is the automaticaly added product —
                // lets calculate the currentSubtotal without the product
                if ( autoAddedLineItem > -1 ) {
                    currentSubtotal -= state.cart.items[autoAddedLineItem].final_line_price;
                }

                if ( currentSubtotal >= promoSubtotal ) {

                    // If there is no a promoVariant product with an applied discount
                    // lets add one with _autoadded property
                    if ( autoAddedLineItem === -1 ) {
                        setTimeout(function(){
                          cartRequestAdd({ 
                              items: [{
                                  id: promoVariant,
                                  quantity: 1,
                                  properties: { "_autoadded": "Yes" }
                              }]  
                          });

                        },100);
                    }
                } else {

                    // If current cart subtotal is less than $100
                    // and an autoadded product is still in the cart —
                    // lets remove it
                    if ( autoAddedLineItem > -1 ) {
                        cartRequestChange({ 
                            "line": autoAddedLineItem + 1,
                            "quantity": 0
                        });
                    }
                }
            }
            
            const promoVariantSelector = document.getElementById("my-cart_finalPrice-" + promoVariant);
            promoVariantSelector.classList.add('discount_price');

         });
    </script>
  {% endif %}


{% endif %}